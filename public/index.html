<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyFridge App</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg-body: #0e1117; --bg-card: #262730; --text-main: #ffffff; --text-sec: #a3a8b8;
            --accent: #ff4b4b; --success: #00d4b1; --nav-bg: #1c1e26; --input-bg: #31333F;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 90px; padding-top: 60px; }

        .header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(14,17,23,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #333; z-index: 100; }
        .header h1 { font-size: 18px; font-weight: 600; margin: 0; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .card-title { font-size: 14px; color: var(--text-sec); margin-bottom: 12px; font-weight: 700; text-transform: uppercase; }

        input, select { background: var(--input-bg); border: 1px solid #41444C; color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin-bottom: 10px; outline: none; -webkit-appearance: none; }
        input:focus, select:focus { border-color: #00d4b1; }
        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 1.5em; }

        .search-bar { position: relative; margin-bottom: 15px; }
        .search-bar input { padding-left: 40px; margin-bottom: 0; border-radius: 20px; background: #1c1e26; border: 1px solid #333; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; }

        .row { display: flex; gap: 10px; }
        button { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: #00d4b1; color: white; }
        .btn-icon { width: auto; background: transparent; padding: 8px; color: var(--text-sec); }
        .btn-delete { color: #ff4b4b; background: rgba(255, 75, 75, 0.1); border-radius: 50%; }
        .btn-save-slider { display: none; width: auto; padding: 5px 10px; background: #fff; color: #000; border-radius: 20px; font-size: 12px; margin-left: 10px; border: 1px solid #ccc; }

        .item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid transparent; transition: opacity 0.3s; }
        .item-info h3 { margin: 0 0 4px 0; font-size: 16px; transition: 0.3s; }
        .item-info p { margin: 0; color: var(--text-sec); font-size: 13px; }
        .urgent { color: #ff4b4b; font-weight: bold; }

        .rules-list { list-style: none; padding: 0; margin: 0; }
        .rules-list li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 12px; }
        .rules-list li:last-child { border-bottom: none; }
        .rule-icon { color: var(--success); font-size: 20px; margin-top: 2px; }
        .rule-text h4 { margin: 0 0 4px 0; font-size: 15px; color: white; }
        .rule-text p { margin: 0; font-size: 13px; color: var(--text-sec); line-height: 1.4; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-card); width: 90%; max-width: 400px; padding: 24px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.1); max-height: 85vh; overflow-y: auto; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-cancel { background: transparent; border: 1px solid #555; color: white; flex: 1; }
        .btn-confirm { background: #00d4b1; color: white; flex: 1; }

        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: black; margin-bottom: 15px; border: 2px solid #333; }
        #result-card { display: none; text-align: center; }
        #result-img { width: 100px; height: 100px; object-fit: contain; border-radius: 8px; background: white; margin-bottom: 10px; }
        .btn-scan-action { width: 48%; display: inline-flex; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; transition: transform 0.3s; }
        .bottom-nav.hidden { transform: translateY(100%); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #555; transition: 0.3s; flex: 1; }
        .nav-item.active { color: #00d4b1; transform: translateY(-5px); }
        .nav-item span { font-size: 28px; margin-bottom: 2px; }
        .nav-item label { font-size: 10px; font-weight: 600; }
        
        .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .chip { padding: 8px 16px; border-radius: 20px; background: #333; color: #aaa; border: 1px solid #444; font-size: 13px; white-space: nowrap; width: auto; transition: 0.2s; }
        .chip.active { background: white; color: black; border-color: white; font-weight: 700; transform: scale(1.05); }

        .view { display: none; } .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        input[type=range] { height: 4px; padding: 0; margin-top: 8px; cursor: grab; }
        input[type=range]:active { cursor: grabbing; }
        #pin-input { font-size: 24px; letter-spacing: 5px; width: 150px; margin: 0 auto 20px auto; display:block; text-align: center; }
    </style>
</head>
<body>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0; color:white;">Confermi?</h3>
            <p id="modal-text" style="color:#aaa;">L'azione √® irreversibile.</p>
            <div class="modal-btns" id="modal-confirm-btns"></div>
        </div>
    </div>

    <div id="modal-edit-frigo" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:white;">Modifica Prodotto</h3>
            <div style="text-align:left; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Nome Prodotto</label>
                <input type="text" id="edit-f-nome" style="margin-bottom: 12px;">

                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <div style="width:40%;">
                        <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Quantit√†</label>
                        <input type="text" id="edit-f-qta" style="width:100%; margin:0;">
                    </div>
                    <div style="width:60%;">
                        <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Categoria</label>
                        <select id="edit-f-cat" style="width:100%; margin:0;">
                            <option value="altro">üì¶ Altro</option><option value="carne">ü•© Carne</option>
                            <option value="pesce">üêü Pesce</option><option value="verdura">ü•¶ Verdura</option>
                            <option value="frutta">üçé Frutta</option><option value="latticini">üßÄ Latticini</option>
                            <option value="bevande">ü•§ Bevande</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Scadenza</label>
                    <input type="date" id="edit-f-scad" style="margin:0; width:100%;">
                </div>
            </div>
            <div class="modal-btns">
                <button onclick="closeEditFrigoModal()" class="btn-cancel">Annulla</button>
                <button onclick="confirmEditFrigo()" class="btn-confirm">Salva Modifiche</button>
            </div>
        </div>
    </div>

    <div id="modal-transfer" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:white;">Completa per il Frigo</h3>
            <p style="color:#aaa; font-size: 13px; margin-bottom: 15px;">Inserisci data e categoria per i prodotti che hai preso.</p>
            <div id="transfer-list" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;"></div>
            <div class="modal-btns">
                <button onclick="closeTransferModal()" class="btn-cancel">Annulla</button>
                <button onclick="confirmTransferAndEmpty()" class="btn-confirm">Salva & Svuota</button>
            </div>
        </div>
    </div>

    <div id="modal-scan-edit" class="modal-overlay">
        <div class="modal-box">
            <h3 id="scan-edit-title" style="margin-top:0; color:white;">Completa Prodotto</h3>
            <p style="color:#aaa; font-size: 13px; margin-bottom: 15px;">Controlla e modifica i dati prima di salvare.</p>

            <div style="text-align:left; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Nome Prodotto</label>
                <input type="text" id="scan-edit-nome" placeholder="Nome prodotto" style="margin-bottom: 12px;">

                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <div style="width:40%;">
                        <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Quantit√†</label>
                        <input type="text" id="scan-edit-qta" placeholder="Qt√†" style="width:100%; margin:0;">
                    </div>
                    <div style="width:60%;" id="scan-edit-cat-container">
                        <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Categoria</label>
                        <select id="scan-edit-cat" style="width:100%; margin:0;">
                            <option value="altro">üì¶ Altro</option><option value="carne">ü•© Carne</option>
                            <option value="pesce">üêü Pesce</option><option value="verdura">ü•¶ Verdura</option>
                            <option value="frutta">üçé Frutta</option><option value="latticini">üßÄ Latticini</option>
                            <option value="bevande">ü•§ Bevande</option>
                        </select>
                    </div>
                </div>

                <div id="scan-edit-scad-container">
                    <label style="font-size:12px; color:#aaa; margin-bottom:4px; display:block;">Scadenza</label>
                    <input type="date" id="scan-edit-scad" style="margin:0; width:100%;">
                </div>
            </div>

            <div class="modal-btns">
                <button onclick="closeScanEditModal()" class="btn-cancel">Annulla</button>
                <button onclick="confirmScanEdit()" class="btn-confirm" id="scan-edit-btn-confirm">Salva</button>
            </div>
        </div>
    </div>

    <div class="header"><h1 id="header-title">MyFridge App</h1></div>

    <div class="container">
        
        <div id="view-login" class="view">
            <div class="card" style="text-align: center; margin-top: 50px;">
                <span class="material-icons-round" style="font-size: 50px; color: #00d4b1; margin-bottom: 20px;">lock</span>
                <h3>Inserisci PIN</h3>
                <p style="color: #aaa; font-size: 14px; margin-bottom: 30px;">Accesso Riservato</p>
                <input type="password" id="pin-input" inputmode="numeric" placeholder="****" maxlength="4">
                <button onclick="checkPin()" class="btn-primary" style="width: 100%; margin-top: 10px;">ACCEDI</button>
                <p id="login-error" style="color: #ff4b4b; display: none; margin-top: 15px;">PIN Errato!</p>
            </div>
        </div>

        <div id="view-frigo" class="view">
            <div class="card">
                <div class="card-title">Aggiungi Prodotto</div>
                <div class="row">
                    <input type="text" id="f-nome" placeholder="Nome (es. Latte)">
                    <select id="f-cat" style="width: 40%;">
                        <option value="altro">üì¶ Altro</option><option value="carne">ü•© Carne</option>
                        <option value="pesce">üêü Pesce</option><option value="verdura">ü•¶ Verdura</option>
                        <option value="frutta">üçé Frutta</option><option value="latticini">üßÄ Latticini</option>
                        <option value="bevande">ü•§ Bevande</option>
                    </select>
                </div>
                <div class="row">
                    <input type="text" id="f-qta" placeholder="Qt√†" style="width: 35%">
                    <input type="date" id="f-scad">
                </div>
                <button onclick="addFrigo()" class="btn-primary" style="margin-top: 10px;">Aggiungi</button>
            </div>
            <div class="search-bar">
                <span class="material-icons-round search-icon">search</span>
                <input type="search" id="search-input" placeholder="Cerca nel frigo..." oninput="onSearch(this.value)">
            </div>
            <div class="filter-scroll">
                <button class="chip active" onclick="setFilter('tutti')" id="btn-tutti">Tutti</button>
                <button class="chip" onclick="setFilter('scadenza')" id="btn-scadenza">‚ö†Ô∏è In Scadenza</button>
                <button class="chip" onclick="setFilter('finiti')" id="btn-finiti">üìâ Quasi Finiti</button>
            </div>
            <div id="lista-frigo"></div>
        </div>

        <div id="view-scanner" class="view">
            <div class="card" style="text-align: center;">
                <div class="card-title">Scannerizza Barcode</div>
                <div id="reader"></div>
                <p id="scan-status" style="color: #666; font-size: 12px; margin-bottom: 10px;">Inquadra un codice a barre...</p>
                
                <div id="result-card">
                    <img id="result-img" src="" alt="Prodotto">
                    <h3 id="result-name" style="margin: 5px 0;">Nome Prodotto</h3>
                    <p id="result-brand" style="color: #aaa; font-size: 12px; margin-bottom: 15px;">Marca</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="openScanEditModal('frigo')" class="btn-primary btn-scan-action">
                            <span class="material-icons-round" style="font-size:16px">kitchen</span> Frigo
                        </button>
                        <button onclick="openScanEditModal('spesa')" class="btn-primary btn-scan-action" style="background: white; color: black;">
                            <span class="material-icons-round" style="font-size:16px">shopping_cart</span> Spesa
                        </button>
                    </div>
                    <button onclick="cancelScan()" class="btn-cancel" style="width: 100%; margin-top: 15px;">
                        <span class="material-icons-round" style="font-size:16px">refresh</span> Scansiona un altro
                    </button>
                </div>
            </div>
        </div>

        <div id="view-spesa" class="view">
            <div class="card">
                <div class="card-title">Cosa manca?</div>
                <div class="row">
                    <input type="text" id="c-nome" placeholder="Prodotto...">
                    <button onclick="addCarrello()" class="btn-primary" style="width: auto; padding: 0 20px;">+</button>
                </div>
            </div>
            <button onclick="askSvuotaAdvanced()" style="background: #262730; color: #00d4b1; border: 1px solid #00d4b1; margin-bottom: 20px;">
                <span class="material-icons-round" style="font-size:18px;">shopping_bag</span> Concludi Spesa (Svuota)
            </button>
            <div id="lista-carrello"></div>
        </div>

        <div id="view-regole" class="view">
            <div class="card">
                <div class="card-title">Guida all'uso</div>
                <ul class="rules-list">
                    <li><span class="material-icons-round rule-icon">snooze</span><div class="rule-text"><h4>Server in Standby</h4><p>Dopo 15 minuti pausa. Se lento, attendi.</p></div></li>
                    <li><span class="material-icons-round rule-icon">qr_code_scanner</span><div class="rule-text"><h4>Scanner</h4><p>Solo per confezionati. Cibo fresco a mano.</p></div></li>
                    <li><span class="material-icons-round rule-icon">delete_sweep</span><div class="rule-text"><h4>Pulizia</h4><p>Togli dal frigo ci√≤ che finisci!</p></div></li>
                    <li><span class="material-icons-round rule-icon">sync</span><div class="rule-text"><h4>Sync</h4><p>Ricarica la pagina per vedere modifiche altrui.</p></div></li>
                </ul>
                <button onclick="logout()" style="background: #333; color: #aaa; margin-top: 20px; font-size: 12px;">Disconnetti</button>
            </div>
        </div>

    </div>

    <div id="bottom-nav" class="bottom-nav hidden">
        <div class="nav-item active" onclick="nav('frigo')">
            <span class="material-icons-round">kitchen</span><label>Frigo</label>
        </div>
        <div class="nav-item" onclick="nav('scanner')">
            <span class="material-icons-round">qr_code_scanner</span><label>Scan</label>
        </div>
        <div class="nav-item" onclick="nav('spesa')">
            <span class="material-icons-round">shopping_cart</span><label>Spesa</label>
        </div>
        <div class="nav-item" onclick="nav('regole')">
            <span class="material-icons-round">info</span><label>Info</label>
        </div>
    </div>

    <script>
        const API = '/api';
        const CORRECT_PIN = "2211";
        let itemToDeleteId = null, deleteType = null;
        let currentFilter = 'tutti';
        let searchTerm = '';
        
        // SCANNER LOGIC RE-WRITTEN
        let html5QrcodeScanner = null;
        let isCameraActive = false; 
        let scanPaused = false; // "Pausa Logica" per non bloccare l'hardware
        
        let scannedProduct = { name: '', qta: '' };
        let itemsToTransfer = []; 
        let scanDest = '';
        
        let allFrigoItems = [];
        let itemToEditId = null;

        const catIcons = { 'carne': 'ü•©', 'pesce': 'üêü', 'verdura': 'ü•¶', 'frutta': 'üçé', 'latticini': 'üßÄ', 'bevande': 'ü•§', 'altro': 'üì¶' };

        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem('myfridge_auth') === 'true') nav('frigo'); else nav('login');
        });

        function checkPin() {
            if (document.getElementById('pin-input').value === CORRECT_PIN) {
                localStorage.setItem('myfridge_auth', 'true');
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('pin-input').value = '';
                nav('frigo');
            } else {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('pin-input').value = '';
            }
        }
        function logout() { localStorage.removeItem('myfridge_auth'); nav('login'); }

        function nav(vista) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + vista).classList.add('active');
            const bottomNav = document.getElementById('bottom-nav');
            if (vista === 'login') {
                bottomNav.classList.add('hidden');
                document.getElementById('header-title').innerText = "Login Richiesto";
                return;
            } else { bottomNav.classList.remove('hidden'); }
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.nav-item');
            if(vista === 'frigo') items[0].classList.add('active');
            if(vista === 'scanner') items[1].classList.add('active');
            if(vista === 'spesa') items[2].classList.add('active');
            if(vista === 'regole') items[3].classList.add('active');
            
            const titles = { 'frigo': 'Il Mio Frigo', 'scanner': 'Scannerizza', 'spesa': 'Lista Spesa', 'regole': 'Guida & Regole' };
            document.getElementById('header-title').innerText = titles[vista];

            if(vista === 'frigo') loadFrigo();
            if(vista === 'spesa') loadCarrello();
            
            if(vista === 'scanner') {
                startScanner();
            } else {
                stopScannerHard(); // Spegne la telecamera solo quando esci dalla scheda
            }
        }

        /* ================================================================= */
        /* --- LOGICA SCANNER ANTIBLOCCO --- */
        /* ================================================================= */

        function startScanner() {
            document.getElementById('result-card').style.display = 'none';
            document.getElementById('scan-status').innerText = "Inquadra un codice a barre...";
            scanPaused = false; // Togliamo il tappo dalle orecchie
            
            if (isCameraActive) return; // Motore gi√† acceso, non serve fare nulla
            
            if (!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader");
            
            html5QrcodeScanner.start(
                { facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, onScanFailure
            ).then(() => { 
                isCameraActive = true; 
            }).catch(err => { 
                document.getElementById('scan-status').innerText = "Errore Fotocamera."; 
            });
        }

        // Spegne fisicamente la telecamera
        async function stopScannerHard() {
            if(html5QrcodeScanner && isCameraActive) {
                try { await html5QrcodeScanner.stop(); } catch(e) {}
                isCameraActive = false;
                scanPaused = false;
            }
        }

        async function onScanSuccess(decodedText) {
            if (scanPaused) return; // Se abbiamo gi√† trovato un codice, ignora gli altri per ora!
            scanPaused = true; // Mettiamo il "tappo alle orecchie" (Pausa logica)
            
            document.getElementById('scan-status').innerText = "Trovato! Ricerca in corso...";
            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`);
                const data = await res.json();
                if (data.status === 1) {
                    const p = data.product;
                    scannedProduct = { name: `${p.product_name || "Sconosciuto"} ${p.brands || ""}`, qta: p.quantity || "1 pz" };
                    document.getElementById('result-name').innerText = scannedProduct.name;
                    document.getElementById('result-img').src = p.image_front_small_url || "https://via.placeholder.com/100";
                    document.getElementById('result-card').style.display = 'block';
                } else {
                    document.getElementById('scan-status').innerText = "Prodotto non trovato nel database.";
                    // Se non lo trova, togliamo la pausa in automatico per fargli riprovare
                    setTimeout(() => { scanPaused = false; startScanner(); }, 2000); 
                }
            } catch (e) { 
                document.getElementById('scan-status').innerText = "Errore di rete."; 
                setTimeout(() => { scanPaused = false; startScanner(); }, 2000); 
            }
        }

        function onScanFailure(error) {}

        function cancelScan() { 
            // Tasto Scansiona un Altro: toglie la pausa e si riparte istantaneamente!
            startScanner(); 
        }

        /* --- MODIFICA DOPO SCAN --- */
        function openScanEditModal(dest) {
            if(!scannedProduct.name) return;
            scanDest = dest;

            document.getElementById('scan-edit-nome').value = scannedProduct.name;
            document.getElementById('scan-edit-qta').value = scannedProduct.qta;

            const catContainer = document.getElementById('scan-edit-cat-container');
            const scadContainer = document.getElementById('scan-edit-scad-container');
            const confirmBtn = document.getElementById('scan-edit-btn-confirm');
            const title = document.getElementById('scan-edit-title');

            if (dest === 'frigo') {
                title.innerText = "Aggiungi al Frigo";
                catContainer.style.display = 'block';
                scadContainer.style.display = 'block';
                document.getElementById('scan-edit-cat').value = 'altro'; 
                const oggi = new Date(); oggi.setDate(oggi.getDate() + 7);
                document.getElementById('scan-edit-scad').value = oggi.toISOString().split('T')[0];
                confirmBtn.innerText = "Salva in Frigo";
            } else {
                title.innerText = "Aggiungi alla Spesa";
                catContainer.style.display = 'none';
                scadContainer.style.display = 'none';
                confirmBtn.innerText = "Salva in Spesa";
            }

            document.getElementById('modal-scan-edit').style.display = 'flex';
        }

        function closeScanEditModal() { document.getElementById('modal-scan-edit').style.display = 'none'; }

        async function confirmScanEdit() {
            const nome = document.getElementById('scan-edit-nome').value;
            const qta = document.getElementById('scan-edit-qta').value;
            if(!nome) return;

            let payload;
            if (scanDest === 'frigo') {
                const cat = document.getElementById('scan-edit-cat').value;
                const scad = document.getElementById('scan-edit-scad').value;
                payload = { nome, quantita: qta, categoria: cat, scadenza: scad };
            } else { payload = { nome, quantita: qta }; }

            await fetch(`${API}/${scanDest}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            closeScanEditModal();
            document.getElementById('result-card').style.display = 'none';
            nav(scanDest); 
        }

        function onSearch(val) { searchTerm = val.toLowerCase(); loadFrigo(); }

        /* --- FRIGO --- */
        function setFilter(tipo) {
            currentFilter = tipo;
            document.querySelectorAll('.chip').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + tipo).classList.add('active');
            loadFrigo();
        }

        async function loadFrigo() {
            const res = await fetch(`${API}/frigo`);
            allFrigoItems = await res.json();
            let data = [...allFrigoItems];
            
            const div = document.getElementById('lista-frigo');
            div.innerHTML = '';
            const oggi = new Date();
            
            if (searchTerm) data = data.filter(item => item.nome.toLowerCase().includes(searchTerm));

            if (currentFilter === 'scadenza') {
                data = data.filter(item => {
                    if (!item.scadenza) return false;
                    const diffDays = Math.ceil((new Date(item.scadenza) - oggi) / (1000 * 60 * 60 * 24)); 
                    return diffDays <= 3;
                });
            } else if (currentFilter === 'finiti') {
                data = data.filter(item => item.rimasto <= 20);
            }

            if(data.length === 0) { div.innerHTML = `<div style="text-align:center; color:#555; margin-top:30px;">Nessun prodotto trovato.</div>`; return; }
            
            data.forEach(item => {
                let avvisoScadenza = '', borderStyle = '';
                if (item.scadenza) {
                    const diffDays = Math.ceil((new Date(item.scadenza) - oggi) / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) { avvisoScadenza = `<span class="urgent">SCADUTO!</span>`; borderStyle = 'border-left-color: #ff4b4b;'; }
                    else if (diffDays <= 3) { avvisoScadenza = `<span class="urgent">Scade tra ${diffDays} gg</span>`; borderStyle = 'border-left-color: orange;'; }
                    else { avvisoScadenza = `<span style="color:#aaa">Scad: ${item.scadenza}</span>`; borderStyle = 'border-left-color: #00d4b1;'; }
                }
                const colorBar = item.rimasto > 50 ? '#00d4b1' : '#ff4b4b';
                const iconaCat = catIcons[item.categoria] || 'üì¶';
                
                div.innerHTML += `
                <div class="item" style="${borderStyle}">
                    <div style="flex:1">
                        <div class="item-info">
                            <h3>${iconaCat} ${item.nome}</h3>
                            <p>${item.quantita} ‚Ä¢ ${avvisoScadenza}</p>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;margin-top:8px">
                            <input type="range" id="slider-${item._id}" min="0" max="100" value="${item.rimasto}" 
                                oninput="onSliderDrag('${item._id}', this.value)"
                                style="accent-color: ${colorBar}; background: linear-gradient(to right, ${colorBar} ${item.rimasto}%, #444 ${item.rimasto}%)">
                            <span id="perc-text-${item._id}" style="font-size:12px; min-width:35px; text-align:right; color: ${colorBar}; font-weight:bold;">${item.rimasto}%</span>
                            <button id="save-btn-${item._id}" onclick="confirmSliderUpdate('${item._id}')" class="btn-save-slider">‚úÖ Salva</button>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap: 5px;">
                        <button onclick="openEditFrigoModal('${item._id}')" class="btn-icon" style="color:#a3a8b8; padding:6px;"><span class="material-icons-round" style="font-size: 20px;">edit</span></button>
                        <button onclick="openModal('${item._id}', 'frigo')" class="btn-icon btn-delete" style="padding:6px;"><span class="material-icons-round" style="font-size: 20px;">delete</span></button>
                    </div>
                </div>`;
            });
        }

        function openEditFrigoModal(id) {
            const item = allFrigoItems.find(i => i._id === id);
            if(!item) return;
            itemToEditId = id;
            document.getElementById('edit-f-nome').value = item.nome || '';
            document.getElementById('edit-f-qta').value = item.quantita || '';
            document.getElementById('edit-f-cat').value = item.categoria || 'altro';
            document.getElementById('edit-f-scad').value = item.scadenza || '';
            document.getElementById('modal-edit-frigo').style.display = 'flex';
        }
        function closeEditFrigoModal() { document.getElementById('modal-edit-frigo').style.display = 'none'; }
        async function confirmEditFrigo() {
            const nome = document.getElementById('edit-f-nome').value;
            const qta = document.getElementById('edit-f-qta').value;
            const cat = document.getElementById('edit-f-cat').value;
            const scad = document.getElementById('edit-f-scad').value;
            if(!nome) return;
            await fetch(`${API}/frigo/${itemToEditId}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nome, quantita: qta, categoria: cat, scadenza: scad }) });
            closeEditFrigoModal();
            loadFrigo();
        }

        function onSliderDrag(id, val) {
            const color = val > 50 ? '#00d4b1' : '#ff4b4b';
            const slider = document.getElementById(`slider-${id}`);
            slider.style.background = `linear-gradient(to right, ${color} ${val}%, #444 ${val}%)`;
            slider.style.accentColor = color;
            const pt = document.getElementById(`perc-text-${id}`);
            pt.innerText = val + '%'; pt.style.color = color;
            document.getElementById(`save-btn-${id}`).style.display = 'inline-block';
        }
        async function confirmSliderUpdate(id) {
            const val = document.getElementById(`slider-${id}`).value;
            await fetch(`${API}/frigo/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ rimasto: val }) });
            document.getElementById(`save-btn-${id}`).style.display = 'none';
            loadFrigo(); 
        }

        async function addFrigo() {
            const nome = document.getElementById('f-nome').value;
            const qta = document.getElementById('f-qta').value;
            const scad = document.getElementById('f-scad').value;
            const cat = document.getElementById('f-cat').value;
            if(!nome) return;
            await fetch(`${API}/frigo`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nome, quantita: qta, scadenza: scad, categoria: cat }) });
            document.getElementById('f-nome').value = '';
            loadFrigo();
        }

        /* --- CARRELLO --- */
        async function loadCarrello() {
            const res = await fetch(`${API}/carrello`);
            const data = await res.json();
            const div = document.getElementById('lista-carrello');
            div.innerHTML = '';
            
            if(data.length === 0) { div.innerHTML = `<div style="text-align:center; color:#555; margin-top:30px;">Carrello vuoto.</div>`; return; }

            data.forEach(item => {
                const isPreso = item.preso;
                const textDec = isPreso ? 'text-decoration: line-through; color: #666;' : '';
                const iconColor = isPreso ? '#666' : '#00d4b1';
                const iconName = isPreso ? 'undo' : 'check_circle';
                
                div.innerHTML += `
                <div class="item" style="border-left: 3px solid ${iconColor}; opacity: ${isPreso ? '0.6' : '1'};">
                    <div class="item-info" style="${textDec}">
                        <h3>${item.nome}</h3><p>Da prendere: ${item.quantita}</p>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="togglePreso('${item._id}', ${!isPreso})" class="btn-icon" style="color:${iconColor}">
                            <span class="material-icons-round" style="font-size:26px;">${iconName}</span>
                        </button>
                        <button onclick="openModal('${item._id}', 'carrello')" class="btn-icon btn-delete" style="padding: 6px;">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>
                </div>`;
            });
        }

        async function addCarrello() {
            const nome = document.getElementById('c-nome').value;
            if(!nome) return;
            await fetch(`${API}/carrello`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nome, quantita: '1 pz' }) });
            document.getElementById('c-nome').value = '';
            loadCarrello();
        }

        async function togglePreso(id, status) {
            await fetch(`${API}/carrello/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ preso: status }) });
            loadCarrello();
        }

        async function askSvuotaAdvanced() {
            const res = await fetch(`${API}/carrello`);
            const cart = await res.json();
            itemsToTransfer = cart.filter(i => i.preso);

            const modal = document.getElementById('modal-confirm');
            const btns = document.getElementById('modal-confirm-btns');

            if (itemsToTransfer.length > 0) {
                document.getElementById('modal-title').innerText = "Spesa Finita!";
                document.getElementById('modal-text').innerText = `Hai spuntato ${itemsToTransfer.length} prodotti. Vuoi spostarli direttamente nel frigo prima di svuotare il carrello?`;
                btns.innerHTML = `
                    <button onclick="closeModal()" class="btn-cancel" style="flex:1;">Annulla</button>
                    <button onclick="executeSvuota(false)" class="btn-cancel" style="flex:1; border-color:#ff4b4b; color:#ff4b4b;">No, Svuota</button>
                    <button onclick="openTransferModal()" class="btn-confirm" style="flex:1.5;">S√¨, Sposta nel Frigo</button>
                `;
            } else {
                document.getElementById('modal-title').innerText = "Svuotare tutto?";
                document.getElementById('modal-text').innerText = "Non hai spuntato nessun prodotto. Sei sicuro di voler cancellare tutta la lista della spesa?";
                btns.innerHTML = `
                    <button onclick="closeModal()" class="btn-cancel">Annulla</button>
                    <button onclick="executeSvuota(false)" class="btn-confirm" style="background:#ff4b4b;">S√¨, Cancella</button>
                `;
            }
            modal.style.display = 'flex';
        }

        async function executeSvuota(withTransfer) {
            closeModal();
            if(!withTransfer) {
                await fetch(`${API}/carrello`, { method: 'DELETE' });
                loadCarrello();
            }
        }

        function openTransferModal() {
            closeModal();
            const listDiv = document.getElementById('transfer-list');
            listDiv.innerHTML = '';
            
            itemsToTransfer.forEach((item, index) => {
                listDiv.innerHTML += `
                <div style="text-align:left; background:rgba(255,255,255,0.05); padding:12px; margin-bottom:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                    <strong style="display:block; margin-bottom:10px; color:#00d4b1; font-size:16px;">${item.nome}</strong>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="trans-qta-${index}" value="${item.quantita}" style="width:40%; padding:10px; margin:0;" placeholder="Qt√†">
                        <select id="trans-cat-${index}" style="width:60%; padding:10px; margin:0;">
                            <option value="altro">üì¶ Altro</option><option value="carne">ü•© Carne</option>
                            <option value="pesce">üêü Pesce</option><option value="verdura">ü•¶ Verdura</option>
                            <option value="frutta">üçé Frutta</option><option value="latticini">üßÄ Latticini</option>
                            <option value="bevande">ü•§ Bevande</option>
                        </select>
                    </div>
                    <input type="date" id="trans-scad-${index}" style="padding:10px; margin:0; width:100%;">
                </div>`;
            });
            document.getElementById('modal-transfer').style.display = 'flex';
        }

        function closeTransferModal() { document.getElementById('modal-transfer').style.display = 'none'; }

        async function confirmTransferAndEmpty() {
            for(let i=0; i<itemsToTransfer.length; i++) {
                const qta = document.getElementById(`trans-qta-${i}`).value;
                const cat = document.getElementById(`trans-cat-${i}`).value;
                const scad = document.getElementById(`trans-scad-${i}`).value;

                await fetch(`${API}/frigo`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nome: itemsToTransfer[i].nome, quantita: qta, categoria: cat, scadenza: scad })
                });
            }
            await fetch(`${API}/carrello`, { method: 'DELETE' });
            closeTransferModal();
            nav('frigo');
        }

        /* --- MODALI BASE --- */
        function openModal(id, type) {
            itemToDeleteId = id; deleteType = type;
            const modal = document.getElementById('modal-confirm');
            const btns = document.getElementById('modal-confirm-btns');
            
            document.getElementById('modal-title').innerText="Eliminare?"; 
            document.getElementById('modal-text').innerText="L'azione √® irreversibile.";
            btns.innerHTML = `
                <button onclick="closeModal()" class="btn-cancel">No</button>
                <button onclick="confirmAction()" class="btn-confirm" style="background:#ff4b4b;">S√¨, Elimina</button>
            `;
            modal.style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal-confirm').style.display = 'none'; }
        
        async function confirmAction() {
            if (deleteType === 'frigo') await fetch(`${API}/frigo/${itemToDeleteId}`, { method: 'DELETE' });
            if (deleteType === 'carrello') await fetch(`${API}/carrello/${itemToDeleteId}`, { method: 'DELETE' });
            closeModal();
            if(deleteType === 'frigo') loadFrigo(); else loadCarrello();
        }
    </script>
</body>
</html>